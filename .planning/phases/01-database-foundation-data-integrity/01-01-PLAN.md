---
phase: 01-database-foundation-data-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/database/data-source.ts
  - apps/backend/src/app.module.ts
  - apps/backend/package.json
autonomous: true

must_haves:
  truths:
    - "TypeORM DataSource config exists and can be used by CLI for migration commands"
    - "synchronize is set to false in all environments"
    - "Migration CLI commands (generate, run, revert, show) work from package.json scripts"
  artifacts:
    - path: "apps/backend/src/database/data-source.ts"
      provides: "TypeORM DataSource configuration for CLI"
      contains: "AppDataSource"
    - path: "apps/backend/src/app.module.ts"
      provides: "synchronize: false configuration"
      contains: "synchronize: false"
    - path: "apps/backend/package.json"
      provides: "Migration CLI scripts"
      contains: "migration:generate"
  key_links:
    - from: "apps/backend/src/database/data-source.ts"
      to: "apps/backend/src/**/*.entity.ts"
      via: "entities glob pattern"
      pattern: "entities.*\\.entity"
    - from: "apps/backend/src/database/data-source.ts"
      to: ".env"
      via: "dotenv config loading"
      pattern: "config.*path"
---

<objective>
Set up TypeORM migration infrastructure and disable synchronize.

Purpose: Establish the migration-only workflow required by DB-05, preventing schema drift and data loss. This is the foundation all other database work depends on.
Output: Working DataSource config, migration CLI scripts, synchronize disabled.
</objective>

<execution_context>
@C:/Users/Yarin David/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Yarin David/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation-data-integrity/01-RESEARCH.md
@apps/backend/src/app.module.ts
@apps/backend/package.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DataSource config and migration scripts</name>
  <files>
    apps/backend/src/database/data-source.ts
    apps/backend/package.json
  </files>
  <action>
    1. Create `apps/backend/src/database/data-source.ts`:
       - Import `DataSource`, `DataSourceOptions` from 'typeorm'
       - Import `config` from 'dotenv' and `join` from 'path'
       - Load .env from monorepo root: `config({ path: join(__dirname, '../../../../.env') })`
       - Export `dataSourceOptions` object with:
         - type: 'postgres'
         - host/port/username/password/database from process.env (POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USERNAME, POSTGRES_PASSWORD, POSTGRES_DATABASE) with defaults matching .env.example
         - entities: `[join(__dirname, '..', '**', '*.entity.ts')]`
         - migrations: `[join(__dirname, '..', 'migrations', '*.ts')]`
         - synchronize: false
         - logging: `process.env.NODE_ENV === 'development'`
       - Export `const AppDataSource = new DataSource(dataSourceOptions)`

    2. Add migration scripts to `apps/backend/package.json` scripts section:
       - "typeorm": "typeorm-ts-node-commonjs -d src/database/data-source.ts"
       - "migration:generate": "npm run typeorm -- migration:generate src/migrations/%npm_config_name%"
       - "migration:run": "npm run typeorm -- migration:run"
       - "migration:revert": "npm run typeorm -- migration:revert"
       - "migration:show": "npm run typeorm -- migration:show"
       - "schema:drop": "npm run typeorm -- schema:drop"

    Note: Use %npm_config_name% (Windows) in the generate script. The research shows $npm_config_name (Unix) but this is a Windows environment.
  </action>
  <verify>
    Run `cd apps/backend && npm run typeorm -- --help` to confirm CLI is accessible.
    Run `npm run build` from repo root to confirm no TypeScript errors.
  </verify>
  <done>DataSource config exports AppDataSource, package.json has 6 migration scripts, TypeORM CLI responds to --help.</done>
</task>

<task type="auto">
  <name>Task 2: Disable synchronize and align app.module.ts with DataSource</name>
  <files>
    apps/backend/src/app.module.ts
  </files>
  <action>
    1. In `apps/backend/src/app.module.ts`, find the TypeORM configuration in `TypeOrmModule.forRootAsync()`.
    2. Change `synchronize: configService.get('NODE_ENV') === 'development'` to `synchronize: false`.
    3. Add migrations config to the TypeORM options:
       - `migrations: [join(__dirname, 'migrations', '*.js')]` (compiled JS for runtime)
       - `migrationsRun: false` (explicit CLI execution only)
       - Import `join` from 'path' if not already imported.
    4. Ensure the entities pattern matches the DataSource config (should already be using autoLoadEntities or explicit entity paths).

    Why synchronize must be false: Research documents this as critical - synchronize: true causes silent data loss, schema drift between environments, and violates DB-05 requirement. This is a one-way change that should never be reverted.
  </action>
  <verify>
    Run `npm run build` from repo root to confirm the backend compiles.
    Grep for "synchronize" in app.module.ts and confirm it shows `synchronize: false`.
  </verify>
  <done>app.module.ts has synchronize: false, migrations array configured, migrationsRun: false. Backend builds successfully.</done>
</task>

</tasks>

<verification>
1. `npm run build` from repo root succeeds (both apps compile)
2. `grep -r "synchronize" apps/backend/src/app.module.ts` shows `false`, not any conditional
3. `apps/backend/src/database/data-source.ts` exists and exports AppDataSource
4. `apps/backend/package.json` contains migration:generate, migration:run, migration:revert scripts
</verification>

<success_criteria>
- TypeORM DataSource configuration file exists at apps/backend/src/database/data-source.ts
- synchronize is unconditionally set to false in app.module.ts
- Migration CLI scripts are available in package.json
- Backend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation-data-integrity/01-01-SUMMARY.md`
</output>
